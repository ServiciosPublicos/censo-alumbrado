<script type="module">
    // Importaciones de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, deleteDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Establecer el nivel de log para depuraci贸n de Firestore
    setLogLevel('Debug');

    // Definiciones de variables globales (App, DB, Auth, Map)
    let app, db, auth;
    let map = null; // Variable para el objeto Leaflet Map
    let userId = null;
    let isAuthReady = false;
    let markers = {}; // Para guardar los marcadores por ID de documento
    let isFirebaseActive = false; // Flag para saber si Firebase est谩 configurado

    // --- Utilidades ---

    /**
     * Muestra un modal de mensaje personalizado (reemplaza alert/confirm)
     * @param {string} title T铆tulo del modal.
     * @param {string} message Mensaje a mostrar.
     */
    function showCustomModal(title, message) {
        const modal = document.getElementById('custom-modal');
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    document.getElementById('modal-close-btn').addEventListener('click', () => {
        const modal = document.getElementById('custom-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // --- Funciones de Geolocalizaci贸n ---

    /**
     * Intenta obtener la ubicaci贸n actual del usuario y centrar el mapa.
     */
    function getGeolocation() {
        const geoStatus = document.getElementById('geo-status');
        geoStatus.textContent = 'Buscando ubicaci贸n...';
        geoStatus.className = 'text-xs font-medium text-blue-500';
        
        if (!navigator.geolocation) {
            geoStatus.textContent = 'Geolocalizaci贸n no soportada por su navegador.';
            geoStatus.className = 'text-xs font-medium text-orange-500';
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                if (map) {
                    map.setView([lat, lng], 16); // Centrar el mapa en la ubicaci贸n
                    
                    // Actualizar formulario y marcador temporal con la ubicaci贸n actual
                    const latInput = document.getElementById('input-lat');
                    const lngInput = document.getElementById('input-lng');
                    const saveBtn = document.getElementById('btn-save');

                    latInput.value = lat.toFixed(6);
                    lngInput.value = lng.toFixed(6);
                    saveBtn.disabled = false;
                    document.getElementById('save-status').textContent = '';

                    if (map.newPointMarker) {
                        map.newPointMarker.setLatLng([lat, lng]);
                    } else {
                        map.newPointMarker = L.marker([lat, lng]).addTo(map)
                            .bindPopup("Nuevo Punto (Ubicaci贸n GPS)").openPopup();
                    }

                    geoStatus.textContent = `Ubicaci贸n encontrada. Precisi贸n: 卤${Math.round(accuracy)}m.`;
                    geoStatus.className = 'text-xs font-medium text-green-600';
                } else {
                    geoStatus.textContent = 'Ubicaci贸n encontrada, esperando inicializaci贸n del mapa.';
                }
            },
            (error) => {
                let message;
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message = "Permiso denegado por el usuario.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = "Informaci贸n de ubicaci贸n no disponible.";
                        break;
                    case error.TIMEOUT:
                        message = "Tiempo de espera agotado. Intenta de nuevo o haz clic en el mapa.";
                        break;
                    default:
                        message = "Error de geolocalizaci贸n desconocido.";
                        break;
                }
                geoStatus.textContent = `GeoError: ${message}`;
                geoStatus.className = 'text-xs font-medium text-red-500';
            },
            // Aumentar el timeout para la llamada manual, ya que el usuario lo solicit贸 expl铆citamente
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } 
        );
    }

    // --- Funciones de Mapa y Leaflet ---

    /**
     * Funci贸n para inicializar el mapa Leaflet.
     * @returns {void}
     */
    function initializeMap() {
        if (map !== null) {
            map.remove(); // Evita re-inicializaciones
        }

        const mapContainer = document.getElementById('map-container');
        if (!mapContainer) {
            console.error("No se encontr贸 el contenedor del mapa con ID 'map-container'.");
            return;
        }

        // 1. Inicializar el mapa
        map = L.map('map-container', {
            center: [19.4326, -99.1332], // Centro predeterminado (Ciudad de M茅xico)
            zoom: 13,
            zoomControl: false 
        });

        // 2. Agregar la capa de tiles de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '漏 OpenStreetMap contributors'
        }).addTo(map);

        // 3. Agregar control de zoom personalizado
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        // 4. Agregar listeners para clicks en el mapa
        map.on('click', onMapClick);

        console.log("Mapa Leaflet inicializado correctamente.");
    }

    /**
     * Manejador de evento al hacer clic en el mapa.
     * @param {L.LeafletMouseEvent} e Evento de click de Leaflet.
     */
    function onMapClick(e) {
        const latInput = document.getElementById('input-lat');
        const lngInput = document.getElementById('input-lng');
        const saveBtn = document.getElementById('btn-save');

        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);

        latInput.value = lat;
        lngInput.value = lng;
        saveBtn.disabled = false; // Habilitar el bot贸n al tener coordenadas
        document.getElementById('save-status').textContent = '';
        document.getElementById('geo-status').textContent = 'Coordenadas seleccionadas.';
        document.getElementById('geo-status').className = 'text-xs font-medium text-gray-700';

        // Opcional: Agregar un marcador temporal en la posici贸n del click
        if (map.newPointMarker) {
            map.newPointMarker.setLatLng(e.latlng);
        } else {
            map.newPointMarker = L.marker(e.latlng).addTo(map)
                .bindPopup("Nuevo Punto (Selecci贸n Manual)").openPopup();
        }
    }

    // --- Funciones de Firebase/Firestore ---

    /**
     * Construye la ruta de la colecci贸n de datos p煤blicos.
     * @returns {string} La ruta completa de la colecci贸n.
     */
    function getCollectionPath() {
        // Usamos una variable global de Canvas para el App ID, cayendo a un default
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Almacenar en /artifacts/{appId}/public/data/lamp_points
        return `artifacts/${appId}/public/data/lamp_points`;
    }
    
    /**
     * Crea un 铆cono personalizado para los marcadores de Leaflet.
     */
    function createLampIcon(type) {
        let color;
        switch(type) {
            case 'LED': color = 'bg-green-500'; break;
            case 'Sodio': color = 'bg-yellow-500'; break;
            case 'Mercurio': color = 'bg-red-500'; break;
            case 'Otra':
            default: color = 'bg-gray-500'; break;
        }

        return L.divIcon({
            className: `custom-div-icon`,
            html: `<div class="p-1 rounded-full ${color} shadow-lg ring-4 ring-white"></div>`,
            iconSize: [20, 20], 
            iconAnchor: [10, 10], 
            popupAnchor: [0, -10] 
        });
    }


    /**
     * Agrega o actualiza un marcador en el mapa.
     */
    function addOrUpdateMarker(data, id) {
        if (!map) return;
        
        const latlng = [data.lat, data.lng];
        const icon = createLampIcon(data.type);
        const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('es-MX', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
        const isOwner = data.userId === userId;
        const userDisplay = isOwner ? 'T煤' : data.userId ? data.userId.substring(0, 8) : 'An贸n.';
        
        const popupContent = `
            <div class="space-y-1 text-sm">
                <p class="font-bold text-gray-800">${data.type} L谩mpara</p>
                <p class="text-xs text-gray-600">Lat: ${data.lat.toFixed(6)}, Lng: ${data.lng.toFixed(6)}</p>
                <p class="text-xs text-gray-600">Notas: ${data.notes || 'Sin observaciones'}</p>
                <p class="text-xs text-gray-500">Reg: ${date} por ${userDisplay}</p>
                ${isOwner ? `<button class="delete-btn text-red-500 hover:text-red-700 text-xs mt-2 w-full border border-red-500 rounded p-1" data-point-id="${id}">Eliminar</button>` : ''}
            </div>
        `;

        if (markers[id]) {
            // Actualizar marcador existente
            markers[id].setLatLng(latlng);
            markers[id].setIcon(icon);
            markers[id].getPopup().setContent(popupContent);
        } else {
            // Crear nuevo marcador
            const marker = L.marker(latlng, { icon: icon }).addTo(map)
                .bindPopup(popupContent);
            markers[id] = marker;
        }
    }
    
    /**
     * Elimina un marcador del mapa y su entrada de Firestore.
     */
    async function deletePoint(id) {
        if (!isFirebaseActive) {
            showCustomModal("Error", "La base de datos no est谩 activa. No se puede eliminar el punto.");
            return;
        }

        if (!db || !userId) {
            showCustomModal("Error", "La base de datos no est谩 inicializada o el usuario no est谩 autenticado.");
            return;
        }

        try {
            // Obtener datos para verificar propiedad (seguridad b谩sica del cliente)
            const docRef = doc(db, getCollectionPath(), id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists() && docSnap.data().userId === userId) {
                await deleteDoc(docRef);
                // onSnapshot manejar谩 la eliminaci贸n visual, pero cerramos el popup si est谩 abierto
                if (map.getContainer().querySelector('.leaflet-popup-content .delete-btn[data-point-id="' + id + '"]')) {
                    map.closePopup();
                }
                showCustomModal("Eliminado", "Punto de alumbrado eliminado correctamente.");
            } else {
                showCustomModal("Acceso Denegado", "Solo puedes eliminar tus propios puntos.");
            }
        } catch (error) {
            console.error("Error al eliminar el punto:", error);
            showCustomModal("Error", `No se pudo eliminar el punto: ${error.message}`);
        }
    }

    // Delegaci贸n de eventos para el bot贸n de eliminar dentro del popup
    document.addEventListener('popupopen', (e) => {
        // Aseg煤rate de que el evento es de un popup de Leaflet
        if (e.popup && e.popup.getElement) {
            const deleteButton = e.popup.getElement().querySelector('.delete-btn');
            if (deleteButton) {
                deleteButton.onclick = (event) => {
                    const pointId = event.target.dataset.pointId;
                    deletePoint(pointId);
                };
            }
        }
    });
    window.deletePoint = deletePoint; // Hacer accesible globalmente para el onclick en el popup


    /**
     * Escucha cambios en tiempo real en la colecci贸n de puntos.
     */
    function setupRealtimeListener() {
        if (!isFirebaseActive || !db || !isAuthReady) return;

        const q = query(collection(db, getCollectionPath()));

        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const docId = change.doc.id;
                const data = change.doc.data();

                if (change.type === "added" || change.type === "modified") {
                    addOrUpdateMarker(data, docId);
                }
                if (change.type === "removed") {
                    if (markers[docId]) {
                        map.removeLayer(markers[docId]);
                        delete markers[docId];
                    }
                }
            });
        }, (error) => {
            console.error("Error al escuchar cambios en tiempo real:", error);
            document.getElementById('geo-status').textContent = `Error de escucha: ${error.message}`;
            document.getElementById('geo-status').className = 'text-xs font-medium text-red-500';
        });
    }
    

    /**
     * Manejador del bot贸n Guardar.
     */
    document.getElementById('btn-save').addEventListener('click', async () => {
        const saveStatus = document.getElementById('save-status');
        
        if (!isFirebaseActive) {
            saveStatus.textContent = 'Error: Base de datos no activa. No se puede guardar.';
            saveStatus.className = 'text-sm text-red-500';
            saveStatus.classList.remove('hidden');
            return;
        }

        if (!db || !userId) {
            saveStatus.textContent = 'Error: Usuario no autenticado para guardar.';
            saveStatus.className = 'text-sm text-red-500';
            saveStatus.classList.remove('hidden');
            return;
        }

        const lat = parseFloat(document.getElementById('input-lat').value);
        const lng = parseFloat(document.getElementById('input-lng').value);
        const type = document.getElementById('select-type').value;
        const notes = document.getElementById('input-notes').value.trim();
        

        if (isNaN(lat) || isNaN(lng) || !type) {
            saveStatus.textContent = 'Por favor, completa las coordenadas y selecciona un tipo de l谩mpara.';
            saveStatus.className = 'text-sm text-red-500';
            saveStatus.classList.remove('hidden');
            return;
        }
        
        saveStatus.textContent = 'Guardando...';
        saveStatus.className = 'text-sm text-blue-500';
        saveStatus.classList.remove('hidden');


        const newPoint = {
            lat: lat,
            lng: lng,
            type: type,
            notes: notes,
            userId: userId,
            // Importante: No uses 'new Date()' directamente en addDoc para FireStore,
            // usa un marcador de tiempo del servidor o convi茅rtelo si es necesario.
            // Para este ejemplo, lo dejaremos como Date() que Firebase maneja.
            timestamp: new Date() 
        };

        try {
            await addDoc(collection(db, getCollectionPath()), newPoint);
            
            saveStatus.textContent = '隆Punto guardado correctamente!';
            saveStatus.className = 'text-sm text-green-600';

            // Limpiar formulario y deshabilitar bot贸n
            document.getElementById('input-lat').value = '';
            document.getElementById('input-lng').value = '';
            document.getElementById('select-type').value = '';
            document.getElementById('input-notes').value = '';
            document.getElementById('btn-save').disabled = true;

            // Quitar el marcador temporal si existe
            if (map.newPointMarker) {
                map.removeLayer(map.newPointMarker);
                map.newPointMarker = null;
            }
        } catch (error) {
            console.error("Error al a帽adir el documento:", error);
            saveStatus.textContent = `Error al guardar: ${error.message}`;
            saveStatus.className = 'text-sm text-red-500';
        }
    });
    
    // Listener para el bot贸n de geolocalizaci贸n
    document.getElementById('btn-get-location').addEventListener('click', getGeolocation);


    // --- Inicializaci贸n de la Aplicaci贸n ---

    /**
     * Inicializa Firebase, autentica al usuario y prepara los listeners de datos.
     */
    async function initializeFirebase() {
        
        //  CONFIGURACIN CORREGIDA 
        // Usamos directamente tu configuraci贸n de Firebase para evitar la dependencia de variables globales.
        const firebaseConfig = {
          apiKey: "AIzaSyBtlHH530iJ4-oHnHP_TmstzYoMBAKjcqI",
          authDomain: "censoalumbradoonline-29023.firebaseapp.com",
          projectId: "censoalumbradoonline-29023",
          storageBucket: "censoalumbradoonline-29023.firebasestorage.app",
          messagingSenderId: "205023155883",
          appId: "1:205023155883:web:1597aa05ecb6c58bda49ee",
          // measurementId: "G-4JR0PJYCDW" // Opcional
        };
        const initialAuthToken = null; // No necesario para An贸nima

        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const authStatus = document.getElementById('auth-status');
        const geoStatus = document.getElementById('geo-status');
        
        // 1. Mostrar la aplicaci贸n (incluso si Firebase falla)
        loadingOverlay.classList.add('opacity-0');
        setTimeout(() => {
            loadingOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
            appContainer.classList.add('opacity-100');
            if (map) {
                map.invalidateSize(); // 隆CLAVE para que Leaflet se dibuje!
            }
        }, 300);

        // 2. Revisar la configuraci贸n de Firebase
        if (!firebaseConfig.projectId || firebaseConfig.projectId.length === 0) {
            isFirebaseActive = false;
            userId = 'NO_DB';
            isAuthReady = true;
            userIdDisplay.textContent = 'BD DESHABILITADA';
            authStatus.className = 'text-xs font-medium text-orange-500';
            geoStatus.textContent = "Advertencia: El guardado en la nube est谩 deshabilitado (projectId vac铆o).";
            geoStatus.className = 'text-xs font-medium text-orange-500';
            return;
        }
        
        // Si la configuraci贸n es v谩lida, intentar inicializar
        isFirebaseActive = true;

        try {
            // 3. Inicializar Firebase y servicios
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 4. Autenticaci贸n (se usa An贸nima ya que no hay token custom)
            await signInAnonymously(auth);

            // 5. Listener de estado de autenticaci贸n
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplay.textContent = userId.substring(0, 8) + '...';
                    authStatus.className = 'text-xs font-medium text-green-600';
                    setupRealtimeListener();

                } else {
                    // Fallback si la autenticaci贸n falla por alguna raz贸n
                    userId = crypto.randomUUID(); 
                    isAuthReady = true;
                    userIdDisplay.textContent = `An贸nimo Fallback (${userId.substring(0, 8)}...)`;
                    authStatus.className = 'text-xs font-medium text-gray-500';
                    setupRealtimeListener();
                }
            });

        } catch (error) {
            console.error("Error al inicializar Firebase o autenticar:", error);
            
            isFirebaseActive = false;
            userId = 'NO_DB';
            isAuthReady = true; // Marca como listo para que el mapa funcione
            userIdDisplay.textContent = 'ERROR BD';
            authStatus.className = 'text-xs font-medium text-red-500';
            
            let errorMessage = `Error Cr铆tico: ${error.message}. Guardado deshabilitado.`;
            if (error.message.includes("auth/configuration-not-found")) {
                errorMessage = "Error Cr铆tico: HABILITA 'Authentication' y 'An贸nimo'. Guardado deshabilitado.";
            }
                
            geoStatus.textContent = errorMessage;
            geoStatus.className = 'text-xs font-medium text-red-500';
        }
    }

    // --- Ejecuci贸n Principal ---

    // 1. Inicializar el mapa
    initializeMap();

    // 2. Iniciar la aplicaci贸n y la autenticaci贸n de Firebase
    initializeFirebase();

</script>