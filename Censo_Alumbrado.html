<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Censo de Alumbrado Público - GeoData</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        :root { font-family: 'Inter', sans-serif; }
        /* Estilos personalizados para el mapa */
        #map-container {
            height: 400px; /* Altura de referencia */
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para el popup de Leaflet */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            border-radius: 0.5rem !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            top: 5px;
            right: 5px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="loading-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-50/75 transition-opacity duration-300">
        <div class="loader"></div>
        <p class="mt-4 text-gray-700 font-semibold">Cargando aplicación...</p>
    </div>

    <div id="app-container" class="hidden opacity-0 transition-opacity duration-300 p-4 md:p-8 space-y-6 max-w-7xl mx-auto">

        <header class="bg-white p-4 rounded-xl shadow-md flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Censo de Alumbrado Público</h1>
            <div class="text-sm space-y-1">
                <p id="auth-status" class="text-gray-600">Estado Auth: <span id="user-id-display" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">...</span></p>
                <p id="geo-status" class="text-gray-600">Haz clic en el mapa para empezar.</p>
            </div>
        </header>

        <div class="bg-white p-4 rounded-xl shadow-md">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">Mapa de Puntos de Alumbrado</h2>
            <div id="map-container" class="z-10 h-96 w-full rounded-lg shadow-inner"></div>
        </div>

        <section id="new-point-form" class="bg-white p-6 rounded-xl shadow-md space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Registrar Nuevo Punto</h2>
            
            <button id="btn-get-location" class="w-full bg-green-500 text-white p-2 rounded-lg font-semibold hover:bg-green-600 transition duration-150">
                Usar Mi Ubicación Actual
            </button>
            <p class="text-sm text-gray-500 text-center">O haz clic en el mapa.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="input-lat" placeholder="Latitud" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50" readonly>
                <input type="text" id="input-lng" placeholder="Longitud" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50" readonly>
            </div>

            <select id="select-type" class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500">
                <option value="" disabled selected>Selecciona Tipo de Lámpara</option>
                <option value="LED">LED</option>
                <option value="Sodio">Sodio</option>
                <option value="Mercurio">Mercurio</option>
                <option value="Otra">Otra</option>
            </select>

            <textarea id="input-notes" placeholder="Observaciones (opcional)" rows="3" class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500"></textarea>

            <button id="btn-save" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 disabled:bg-blue-300" disabled>
                Guardar Punto
            </button>
            <p id="save-status" class="text-sm text-green-600 hidden text-center"></p>
        </section>

        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-[1000]">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full space-y-4">
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">Título</h3>
                <p id="modal-message" class="text-gray-600">Mensaje.</p>
                <button id="modal-close-btn" class="w-full bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">Cerrar</button>
            </div>
        </div>

    </div>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, deleteDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de log para depuración de Firestore
        setLogLevel('Debug');

        // Definiciones de variables globales (App, DB, Auth, Map)
        let app, db, auth;
        let map = null; // Variable para el objeto Leaflet Map
        let userId = null;
        let isAuthReady = false;
        let markers = {}; // Para guardar los marcadores por ID de documento
        let isFirebaseActive = false; // Flag para saber si Firebase está configurado

        // --- Utilidades ---

        /**
         * Muestra un modal de mensaje personalizado (reemplaza alert/confirm)
         * @param {string} title Título del modal.
         * @param {string} message Mensaje a mostrar.
         */
        function showCustomModal(title, message) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // NO se llama a modal-close-btn.addEventListener aquí, se mueve a DOMContentLoaded.

        // --- Funciones de Geolocalización ---

        /**
         * Intenta obtener la ubicación actual del usuario y centrar el mapa.
         */
        function getGeolocation() {
            const geoStatus = document.getElementById('geo-status');
            geoStatus.textContent = 'Buscando ubicación...';
            geoStatus.className = 'text-xs font-medium text-blue-500';
            
            if (!navigator.geolocation) {
                geoStatus.textContent = 'Geolocalización no soportada por su navegador.';
                geoStatus.className = 'text-xs font-medium text-orange-500';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    if (map) {
                        map.setView([lat, lng], 16); // Centrar el mapa en la ubicación
                        
                        // Actualizar formulario y marcador temporal con la ubicación actual
                        const latInput = document.getElementById('input-lat');
                        const lngInput = document.getElementById('input-lng');
                        const saveBtn = document.getElementById('btn-save');

                        latInput.value = lat.toFixed(6);
                        lngInput.value = lng.toFixed(6);
                        saveBtn.disabled = false;
                        document.getElementById('save-status').textContent = '';

                        if (map.newPointMarker) {
                            map.newPointMarker.setLatLng([lat, lng]);
                        } else {
                            map.newPointMarker = L.marker([lat, lng]).addTo(map)
                                .bindPopup("Nuevo Punto (Ubicación GPS)").openPopup();
                        }

                        geoStatus.textContent = `Ubicación encontrada. Precisión: ±${Math.round(accuracy)}m.`;
                        geoStatus.className = 'text-xs font-medium text-green-600