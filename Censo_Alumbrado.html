<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Censo de Alumbrado Público</title>
    <!-- Carga de Tailwind CSS para estilos rápidos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Personalización de la fuente Inter */
        :root {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-white text-lg font-semibold flex items-center">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Cargando servicios de autenticación...
        </div>
    </div>

    <div id="app-container" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10 transition-all duration-300 opacity-0 hidden">
        <h1 class="text-3xl font-extrabold text-blue-800 mb-6 border-b pb-2">Censo Digital de Alumbrado Público</h1>
        
        <!-- Muestra el ID de Usuario (requerido para apps colaborativas) -->
        <div id="user-info" class="mb-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
            <p>ID de la App: <span id="app-id" class="font-mono text-gray-700"></span></p>
            <p>Tu ID de Usuario: <span id="user-id" class="font-mono text-gray-700">Cargando...</span></p>
        </div>

        <!-- Sección de Captura de Punto -->
        <div class="mb-8 p-6 bg-gray-50 border rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Registrar Nuevo Punto</h2>
            <button id="add-point-btn" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center justify-center" disabled>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Capturar Mi Ubicación Actual
            </button>
            <p id="geo-status" class="mt-3 text-sm text-red-500"></p>
        </div>

        <!-- Sección de Puntos Registrados -->
        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Puntos de Alumbrado Registrados (Tiempo Real)</h2>
            <p id="points-count" class="text-sm text-gray-500 mb-4">Total de puntos: 0</p>
            <div id="points-list" class="space-y-3">
                <!-- Los puntos registrados se insertarán aquí -->
                <p class="text-gray-500 italic" id="no-points-message">No hay puntos registrados aún. ¡Sé el primero!</p>
            </div>
        </div>

    </div>

    <!-- Script de Firebase y lógica del Censo -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase - Utilizando variables globales
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        let db;
        let auth;
        let userId = 'anonymous';

        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const userIdSpan = document.getElementById('user-id');
        const appIdSpan = document.getElementById('app-id');
        const addPointBtn = document.getElementById('add-point-btn');
        const geoStatus = document.getElementById('geo-status');
        const pointsList = document.getElementById('points-list');
        const pointsCount = document.getElementById('points-count');
        const noPointsMessage = document.getElementById('no-points-message');

        // Función de inicialización
        async function initializeFirebase() {
            try {
                // Habilitar logs para debugging (opcional, pero útil)
                setLogLevel('debug');

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Manejo de Autenticación
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Esperar a que el estado de autenticación cambie
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpan.textContent = userId;
                        addPointBtn.disabled = false;
                        geoStatus.textContent = "Listo para capturar puntos.";
                        
                        // Inicializar el listener de Firestore solo después de la autenticación
                        listenForGeoPoints();
                    } else {
                        userIdSpan.textContent = 'No autenticado';
                        addPointBtn.disabled = true;
                        geoStatus.textContent = "Error de autenticación. No se puede capturar.";
                    }

                    appIdSpan.textContent = appId;
                    // Ocultar overlay y mostrar app
                    loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        appContainer.classList.add('opacity-100');
                    }, 300);
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                geoStatus.textContent = `Error crítico: ${error.message}`;
                addPointBtn.disabled = true;
            }
        }

        /**
         * FUNCIÓN CRÍTICA CORREGIDA: Construye la referencia de la colección.
         * Colección pública (5 segmentos, impar): artifacts/{appId}/public/data/geo_points
         */
        function getGeoPointsCollectionRef() {
            // El nombre de la colección es 'geo_points'
            const collectionPath = `artifacts/${appId}/public/data/geo_points`;
            console.log("Ruta de Colección Usada (Debe ser impar):", collectionPath);
            return collection(db, collectionPath);
        }

        // 2. Función para Agregar Punto
        function addGeoPoint(latitude, longitude) {
            if (!db) {
                console.error("Firestore no inicializado.");
                return;
            }

            const geoData = {
                lat: latitude,
                lng: longitude,
                timestamp: serverTimestamp(),
                capturedBy: userId,
                // Agrega cualquier otro campo relevante para el censo aquí (e.g., tipo de luminaria)
            };

            addDoc(getGeoPointsCollectionRef(), geoData)
                .then(() => {
                    geoStatus.textContent = `Punto registrado en: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}.`;
                    geoStatus.classList.remove('text-red-500');
                    geoStatus.classList.add('text-green-600');
                })
                .catch(error => {
                    console.error("Error al añadir documento:", error);
                    geoStatus.textContent = `Error al registrar el punto: ${error.message}`;
                    geoStatus.classList.remove('text-green-600');
                    geoStatus.classList.add('text-red-500');
                });
        }

        // 3. Listener en Tiempo Real
        function listenForGeoPoints() {
            const q = query(getGeoPointsCollectionRef());

            onSnapshot(q, (snapshot) => {
                const points = [];
                snapshot.forEach((doc) => {
                    points.push({ id: doc.id, ...doc.data() });
                });
                
                renderPointsList(points);
                pointsCount.textContent = `Total de puntos: ${points.length}`;

            }, (error) => {
                console.error("Error en onSnapshot:", error);
                // Mostrar error al usuario
                geoStatus.textContent = `Error de conexión en tiempo real: ${error.message}`;
            });
        }
        
        // 4. Renderizado de Puntos
        function renderPointsList(points) {
            pointsList.innerHTML = ''; // Limpiar lista
            
            if (points.length === 0) {
                noPointsMessage.classList.remove('hidden');
                pointsList.appendChild(noPointsMessage);
                return;
            }
            noPointsMessage.classList.add('hidden');


            // Ordenar por timestamp descendente para ver los más recientes primero
            points.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            points.forEach(point => {
                const timeStr = point.timestamp ? new Date(point.timestamp.toDate()).toLocaleString('es-MX') : 'Cargando...';
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 bg-white rounded-lg shadow-sm hover:shadow-md transition duration-150';
                div.innerHTML = `
                    <p class="text-gray-900 font-medium">Coordenadas: <span class="font-mono text-sm text-blue-600">${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</span></p>
                    <p class="text-xs text-gray-500 mt-1">Registrado por: ${point.capturedBy}</p>
                    <p class="text-xs text-gray-500">Hora: ${timeStr}</p>
                `;
                pointsList.appendChild(div);
            });
        }
        
        // 5. Manejo de Geoposicionamiento
        addPointBtn.addEventListener('click', () => {
            geoStatus.textContent = "Obteniendo ubicación...";
            geoStatus.classList.remove('text-green-600');
            geoStatus.classList.add('text-red-500');
            
            if (navigator.geolocation) {
                addPointBtn.disabled = true;
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        addGeoPoint(latitude, longitude);
                        addPointBtn.disabled = false;
                    },
                    (error) => {
                        geoStatus.textContent = `Error de Geo-localización: ${error.message}. Asegúrate de permitir el acceso.`;
                        addPointBtn.disabled = false;
                        console.error(error);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                geoStatus.textContent = "El navegador no soporta Geo-localización.";
            }
        });

        // Iniciar la aplicación
        initializeFirebase();

    </script>
</body>
</html>