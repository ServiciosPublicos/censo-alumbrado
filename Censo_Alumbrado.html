<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Censo de Alumbrado Público</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el ícono de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <!-- EL LOADING OVERLAY SE QUEDA FIJO HASTA QUE LA AUTENTICACIÓN TERMINE -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-white text-lg font-semibold flex items-center">
            <div class="loader mr-3"></div>
            Cargando servicios de autenticación...
        </div>
    </div>

    <div id="app-container" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10 transition-all duration-300 opacity-0 hidden">
        <h1 class="text-3xl font-extrabold text-blue-800 mb-6 border-b pb-2">Censo Digital de Alumbrado Público</h1>
        
        <div id="user-info" class="mb-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
            <p>ID de la App: <span id="app-id" class="font-mono text-gray-700">Cargando...</span></p>
            <p>Tu ID de Usuario: <span id="user-id" class="font-mono text-gray-700">Cargando...</span></p>
        </div>

        <div class="mb-8 p-6 bg-gray-50 border rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Registrar Nuevo Punto</h2>
            <button id="add-point-btn" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center justify-center" disabled>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Capturar Mi Ubicación Actual
            </button>
            <p id="geo-status" class="mt-3 text-sm text-red-500"></p>
        </div>

        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Puntos de Alumbrado Registrados (Tiempo Real)</h2>
            <p id="points-count" class="text-sm text-gray-500 mb-4">Total de puntos: 0</p>
            <div id="points-list" class="space-y-3">
                <p class="text-gray-500 italic" id="no-points-message">No hay puntos registrados aún. ¡Sé el primero!</p>
            </div>
        </div>
        
        <!-- Contenedor para mensajes de error o éxito personalizados -->
        <div id="message-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    </div>

    <!-- Script de Firebase y lógica del Censo -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // CONFIGURACIÓN ESTÁTICA (FALLBACK) - ¡CLAVE CORREGIDA!
        // Se usa si las variables globales de Canvas no están disponibles.
        // =========================================================================
        const FALLBACK_FIREBASE_CONFIG = {
            // Esta clave está corregida según tu último mensaje
            apiKey: "AIzaSyBtlHH530iJ4-oHnHP_TmstzYoMBAKjcqI", 
            authDomain: "censoalumbradoonline-29023.firebaseapp.com",
            projectId: "censoalumbradoonline-29023",
            storageBucket: "censoalumbradoonline-29023.firebasestorage.app",
            messagingSenderId: "205023155883",
            appId: "1:205023155883:web:1597aa05ecb6c58bda49ee",
            measurementId: "G-4JR0PJYCDW"
        };
        const FALLBACK_APP_DATA_ID = "censo-alumbrado-publico-v1";

        // =========================================================================
        // Detección de entorno (Hybrid Auth)
        // Usa las variables de Canvas si están, si no, usa el Fallback.
        // =========================================================================
        let firebaseConfig = null;
        let initialAuthToken = null;
        let appId = FALLBACK_APP_DATA_ID;
        
        try {
            // 1. Intenta cargar las variables de Canvas (Prioridad)
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            appId = typeof __app_id !== 'undefined' ? __app_id : FALLBACK_APP_DATA_ID; 

            if (!firebaseConfig) {
                // 2. Si la inyección falló, usamos el fallback (Netlify)
                firebaseConfig = FALLBACK_FIREBASE_CONFIG;
                console.warn("ADVERTENCIA: Usando configuración estática (Fallback) de Firebase.");
            }

        } catch (e) {
            // 3. Si hay un error, usamos el fallback
            firebaseConfig = FALLBACK_FIREBASE_CONFIG;
            console.error("Fallo la carga de variables de Canvas. Usando configuración estática. Error:", e);
        }

        let app;
        let db;
        let auth;
        let userId = 'anonymous';

        // Elementos del DOM
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const userIdSpan = document.getElementById('user-id');
        const appIdSpan = document.getElementById('app-id');
        const addPointBtn = document.getElementById('add-point-btn');
        const geoStatus = document.getElementById('geo-status');
        const pointsList = document.getElementById('points-list');
        const pointsCount = document.getElementById('points-count');
        const noPointsMessage = document.getElementById('no-points-message');

        // Función para mostrar mensajes personalizados (reemplazo de alert/confirm)
        function showMessage(type, message) {
            const container = document.getElementById('message-container');
            const colorClasses = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const div = document.createElement('div');
            div.className = `${colorClasses[type]} text-white p-3 rounded-lg shadow-lg max-w-xs transition-opacity duration-300 opacity-0`;
            div.textContent = message;
            
            container.appendChild(div);
            
            // Animación de entrada
            setTimeout(() => div.classList.add('opacity-100'), 10);

            // Animación de salida y remoción
            setTimeout(() => {
                div.classList.remove('opacity-100');
                div.classList.add('opacity-0');
                setTimeout(() => div.remove(), 300);
            }, 5000);
        }

        // Función de inicialización
        async function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Configuración de Firebase incompleta o no disponible.");
                }
                
                setLogLevel('debug'); // Útil para ver logs de Firebase en la consola

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                appIdSpan.textContent = appId;


                // Lógica de autenticación: Usar token custom si está disponible, sino anónimo
                // Si initialAuthToken es null, signInWithCustomToken lanzará un error que catch manejará
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Si el token no está disponible (Netlify o fallo de inyección), usamos anónimo
                    await signInAnonymously(auth);
                }

                
                // Esperar a que el estado de autenticación cambie
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; 
                        userIdSpan.textContent = userId;
                        addPointBtn.disabled = false;
                        geoStatus.textContent = "Listo para capturar puntos.";
                        geoStatus.classList.remove('text-red-500');
                        geoStatus.classList.add('text-green-600');
                        
                        listenForGeoPoints();
                    } else {
                        userIdSpan.textContent = 'NO AUTENTICADO';
                        addPointBtn.disabled = true;
                        geoStatus.textContent = "Error: La sesión no se pudo establecer. Verifica tus reglas de seguridad.";
                        geoStatus.classList.remove('text-green-600');
                        geoStatus.classList.add('text-red-500');
                    }

                    // Ocultar overlay y mostrar app
                    loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        appContainer.classList.add('opacity-100');
                    }, 300);
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                
                let errorMessage;
                if (error.message.includes("api-key-not-valid")) {
                    errorMessage = "Error Crítico: API Key inválida (Revisa tu configuración en Firebase).";
                } else if (error.message.includes("network-request-failed")) {
                    errorMessage = "Error de red: No se pudo conectar a Firebase.";
                } else if (error.message.includes("project-not-found")) {
                    errorMessage = "Error: ID de proyecto no encontrado.";
                } else {
                    errorMessage = `Error Crítico: ${error.message}`;
                }
                    
                geoStatus.textContent = errorMessage;
                addPointBtn.disabled = true;
                
                // Asegurar que el overlay se quite incluso con errores
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('opacity-100');
                }, 300);
            }
        }

        /**
         * FUNCIÓN CRÍTICA: Construye la referencia de la colección para datos PÚBLICOS.
         * Colección pública: artifacts/{appId}/public/data/geo_points
         */
        function getGeoPointsCollectionRef() {
            // Se usa el appId cargado (ya sea del sistema o del fallback)
            const collectionPath = `artifacts/${appId}/public/data/geo_points`; 
            return collection(db, collectionPath);
        }

        // 2. Función para Agregar Punto
        function addGeoPoint(latitude, longitude) {
            if (!db) {
                console.error("Firestore no inicializado.");
                return;
            }

            const geoData = {
                lat: latitude,
                lng: longitude,
                timestamp: serverTimestamp(),
                capturedBy: userId,
            };

            addDoc(getGeoPointsCollectionRef(), geoData)
                .then(() => {
                    showMessage('success', `¡Punto registrado! Lat: ${latitude.toFixed(4)}`);
                    geoStatus.textContent = `Punto registrado en: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}.`;
                })
                .catch(error => {
                    console.error("Error al añadir documento:", error);
                    // Esto a menudo ocurre por un problema de reglas de seguridad
                    let errorMsg = error.message.includes('permission-denied') 
                                ? 'Error de Permiso: Revisa las reglas de seguridad de Firestore.' 
                                : `Error al registrar: ${error.message}`;

                    showMessage('error', errorMsg);
                    geoStatus.textContent = errorMsg;
                    geoStatus.classList.remove('text-green-600');
                    geoStatus.classList.add('text-red-500');
                });
        }

        // 3. Listener en Tiempo Real
        function listenForGeoPoints() {
            const q = query(getGeoPointsCollectionRef());

            onSnapshot(q, (snapshot) => {
                const points = [];
                snapshot.forEach((doc) => {
                    points.push({ id: doc.id, ...doc.data() });
                });
                
                renderPointsList(points);
                pointsCount.textContent = `Total de puntos: ${points.length}`;

            }, (error) => {
                console.error("Error en onSnapshot:", error);
                showMessage('error', `Error de conexión en tiempo real: ${error.message}`);
                geoStatus.textContent = `Error de conexión en tiempo real: ${error.message}`;
            });
        }
        
        // 4. Renderizado de Puntos
        function renderPointsList(points) {
            pointsList.innerHTML = ''; 
            
            if (points.length === 0) {
                noPointsMessage.classList.remove('hidden');
                pointsList.appendChild(noPointsMessage);
                return;
            }
            noPointsMessage.classList.add('hidden');

            points.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            points.forEach(point => {
                const timeStr = point.timestamp ? new Date(point.timestamp.toDate()).toLocaleString('es-MX') : 'Cargando...';
                // Para evitar mostrar todo el ID largo, mostramos solo una parte.
                const displayId = point.capturedBy.length > 15 ? point.capturedBy.substring(0, 8) + '...' : point.capturedBy; 
                
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 bg-white rounded-lg shadow-sm hover:shadow-md transition duration-150';
                div.innerHTML = `
                    <p class="text-gray-900 font-medium">Coordenadas: <span class="font-mono text-sm text-blue-600">${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</span></p>
                    <p class="text-xs text-gray-500 mt-1">Registrado por: ${displayId}</p>
                    <p class="text-xs text-gray-500">Hora: ${timeStr}</p>
                `;
                pointsList.appendChild(div);
            });
        }
        
        // 5. Manejo de Geoposicionamiento
        addPointBtn.addEventListener('click', () => {
            geoStatus.textContent = "Obteniendo ubicación...";
            geoStatus.classList.remove('text-green-600');
            geoStatus.classList.add('text-red-500');
            
            if (navigator.geolocation) {
                addPointBtn.disabled = true;
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        addGeoPoint(latitude, longitude);
                        addPointBtn.disabled = false;
                    },
                    (error) => {
                        showMessage('error', `Permiso de ubicación denegado o error: ${error.message}`);
                        geoStatus.textContent = `Error de Geo-localización: ${error.message}. Asegúrate de permitir el acceso.`;
                        addPointBtn.disabled = false;
                        console.error(error);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showMessage('error', "El navegador no soporta Geo-localización.");
                geoStatus.textContent = "El navegador no soporta Geo-localización.";
            }
        });

        // Iniciar la aplicación
        initializeFirebase();

    </script>
</body>
</html>