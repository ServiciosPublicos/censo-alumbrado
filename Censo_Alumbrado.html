<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Censo de Alumbrado Público - GeoData</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS y JS para el mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        :root { font-family: 'Inter', sans-serif; }
        /* Estilos personalizados para el mapa */
        #map-container {
            height: 400px; /* Altura de referencia */
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para el popup de Leaflet */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            border-radius: 0.5rem !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            top: 5px;
            right: 5px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="loading-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-50/75 transition-opacity duration-300">
        <div class="loader"></div>
        <p class="mt-4 text-gray-700 font-semibold">Cargando aplicación...</p>
    </div>

    <!-- Contenedor Principal (Inicialmente oculto) -->
    <div id="app-container" class="hidden opacity-0 transition-opacity duration-300 p-4 md:p-8 space-y-6 max-w-7xl mx-auto">

        <!-- Header -->
        <header class="bg-white p-4 rounded-xl shadow-md flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Censo de Alumbrado Público</h1>
            <div class="text-sm">
                <p id="auth-status" class="text-gray-600">Estado Auth: <span id="user-id-display" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">...</span></p>
                <p id="geo-status" class="text-gray-600"></p>
            </div>
        </header>

        <!-- Contenedor del Mapa -->
        <div class="bg-white p-4 rounded-xl shadow-md">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">Mapa de Puntos de Alumbrado</h2>
            <div id="map-container" class="z-10 h-96 w-full rounded-lg shadow-inner"></div>
        </div>

        <!-- Formulario de Nuevo Punto (Opción B) -->
        <section id="new-point-form" class="bg-white p-6 rounded-xl shadow-md space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Registrar Nuevo Punto</h2>
            <p class="text-sm text-gray-500">Haz clic en el mapa para establecer las coordenadas del nuevo punto.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="input-lat" placeholder="Latitud (automático al hacer click)" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" readonly>
                <input type="text" id="input-lng" placeholder="Longitud (automático al hacer click)" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" readonly>
            </div>

            <select id="select-type" class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500">
                <option value="" disabled selected>Selecciona Tipo de Lámpara</option>
                <option value="LED">LED</option>
                <option value="Sodio">Sodio</option>
                <option value="Mercurio">Mercurio</option>
                <option value="Otra">Otra</option>
            </select>

            <textarea id="input-notes" placeholder="Observaciones (opcional)" rows="3" class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500"></textarea>

            <button id="btn-save" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 disabled:bg-blue-300" disabled>
                Guardar Punto
            </button>
            <p id="save-status" class="text-sm text-green-600 hidden"></p>
        </section>

        <!-- Tabla/Listado de Datos (Futuro) -->
        <!-- <section class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-semibold text-gray-700">Datos Recolectados</h2>
            <p class="text-sm text-gray-500">Aquí se mostrará un listado de los puntos registrados (implementación futura).</p>
        </section> -->

        <!-- Modal de Mensajes Personalizado -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-[1000]">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full space-y-4">
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">Título</h3>
                <p id="modal-message" class="text-gray-600">Mensaje.</p>
                <button id="modal-close-btn" class="w-full bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">Cerrar</button>
            </div>
        </div>

    </div>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de log para depuración de Firestore
        setLogLevel('Debug');

        // Definiciones de variables globales (App, DB, Auth, Map)
        let app, db, auth;
        let map = null; // Variable para el objeto Leaflet Map
        let userId = null;
        let isAuthReady = false;
        let markers = {}; // Para guardar los marcadores por ID de documento

        // --- Utilidades ---

        /**
         * Muestra un modal de mensaje personalizado (reemplaza alert/confirm)
         * @param {string} title Título del modal.
         * @param {string} message Mensaje a mostrar.
         */
        function showCustomModal(title, message) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        // --- Funciones de Geolocalización ---

        /**
         * Intenta obtener la ubicación actual del usuario y centrar el mapa.
         */
        function getGeolocation() {
            const geoStatus = document.getElementById('geo-status');
            geoStatus.textContent = 'Buscando ubicación...';
            geoStatus.className = 'text-xs font-medium text-blue-500';
            
            if (!navigator.geolocation) {
                geoStatus.textContent = 'Geolocalización no soportada por su navegador.';
                geoStatus.className = 'text-xs font-medium text-orange-500';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    if (map) {
                        map.setView([lat, lng], 16); // Centrar el mapa en la ubicación
                        geoStatus.textContent = `Ubicación encontrada. Precisión: ±${Math.round(accuracy)}m.`;
                        geoStatus.className = 'text-xs font-medium text-green-500';
                    } else {
                        geoStatus.textContent = 'Ubicación encontrada, esperando inicialización del mapa.';
                    }
                },
                (error) => {
                    let message;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message = "Permiso denegado por el usuario.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = "Información de ubicación no disponible.";
                            break;
                        case error.TIMEOUT:
                            message = "Tiempo de espera agotado.";
                            break;
                        default:
                            message = "Error de geolocalización desconocido.";
                            break;
                    }
                    geoStatus.textContent = `GeoError: ${message}`;
                    geoStatus.className = 'text-xs font-medium text-red-500';
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        // --- Funciones de Mapa y Leaflet ---

        /**
         * Función para inicializar el mapa Leaflet.
         * @returns {void}
         */
        function initializeMap() {
            if (map !== null) {
                map.remove(); // Evita re-inicializaciones
            }

            const mapContainer = document.getElementById('map-container');
            if (!mapContainer) {
                console.error("No se encontró el contenedor del mapa con ID 'map-container'.");
                return;
            }

            // 1. Inicializar el mapa
            map = L.map('map-container', {
                center: [19.4326, -99.1332], // Ciudad de México (ejemplo)
                zoom: 13,
                zoomControl: false // Ocultamos el control de zoom predeterminado
            });

            // 2. Agregar la capa de tiles de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // 3. Agregar control de zoom personalizado
            L.control.zoom({
                position: 'topright'
            }).addTo(map);

            // 4. Agregar listeners para clicks en el mapa
            map.on('click', onMapClick);

            console.log("Mapa Leaflet inicializado correctamente.");

            // Opcional: Centrar el mapa en la ubicación del usuario si está disponible
            getGeolocation();
        }

        /**
         * Manejador de evento al hacer clic en el mapa.
         * @param {L.LeafletMouseEvent} e Evento de click de Leaflet.
         */
        function onMapClick(e) {
            const latInput = document.getElementById('input-lat');
            const lngInput = document.getElementById('input-lng');
            const saveBtn = document.getElementById('btn-save');

            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);

            latInput.value = lat;
            lngInput.value = lng;
            saveBtn.disabled = false; // Habilitar el botón al tener coordenadas
            document.getElementById('save-status').textContent = '';

            // Opcional: Agregar un marcador temporal en la posición del click
            if (map.newPointMarker) {
                map.newPointMarker.setLatLng(e.latlng);
            } else {
                map.newPointMarker = L.marker(e.latlng).addTo(map)
                    .bindPopup("Nuevo Punto (Céntrico)").openPopup();
            }
        }

        // --- Funciones de Firebase/Firestore ---

        /**
         * Construye la ruta de la colección de datos públicos.
         * @returns {string} La ruta completa de la colección.
         */
        function getCollectionPath() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Almacenar en /artifacts/{appId}/public/data/lamp_points
            return `artifacts/${appId}/public/data/lamp_points`;
        }
        
        /**
         * Crea un ícono personalizado para los marcadores de Leaflet.
         * @param {string} color El color del ícono (p. ej., 'blue', 'red').
         * @returns {L.Icon} El objeto Icon de Leaflet.
         */
        function createLampIcon(type) {
            let color;
            switch(type) {
                case 'LED': color = 'bg-green-500'; break;
                case 'Sodio': color = 'bg-yellow-500'; break;
                case 'Mercurio': color = 'bg-red-500'; break;
                case 'Otra':
                default: color = 'bg-gray-500'; break;
            }

            return L.divIcon({
                className: `custom-div-icon`,
                html: `<div class="p-1 rounded-full ${color} shadow-lg ring-4 ring-white"></div>`,
                iconSize: [20, 20], // Tamaño del icono
                iconAnchor: [10, 10], // Punto del icono que corresponde a la lat/lng
                popupAnchor: [0, -10] // Posición del popup
            });
        }


        /**
         * Agrega o actualiza un marcador en el mapa.
         * @param {Object} data Datos del punto de alumbrado.
         * @param {string} id ID del documento de Firestore.
         */
        function addOrUpdateMarker(data, id) {
            const latlng = [data.lat, data.lng];
            const icon = createLampIcon(data.type);
            const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'N/A';
            const userPart = data.userId ? data.userId.substring(0, 4) : 'Anón.';
            
            const popupContent = `
                <div class="space-y-1">
                    <p class="font-bold text-gray-800">${data.type} Lámpara</p>
                    <p class="text-xs text-gray-600">Lat: ${data.lat}, Lng: ${data.lng}</p>
                    <p class="text-xs text-gray-600">Notas: ${data.notes || 'Sin observaciones'}</p>
                    <p class="text-xs text-gray-500">Reg: ${date} por ${userPart}...</p>
                    <button class="text-red-500 hover:text-red-700 text-xs mt-1" onclick="deletePoint('${id}')">Eliminar</button>
                </div>
            `;

            if (markers[id]) {
                // Actualizar marcador existente
                markers[id].setLatLng(latlng);
                markers[id].setIcon(icon);
                markers[id].getPopup().setContent(popupContent);
            } else {
                // Crear nuevo marcador
                const marker = L.marker(latlng, { icon: icon }).addTo(map)
                    .bindPopup(popupContent);
                markers[id] = marker;
            }
        }
        
        /**
         * Elimina un marcador del mapa y su entrada de Firestore.
         * @param {string} id ID del documento de Firestore.
         */
        async function deletePoint(id) {
            // Asegúrate de que la función global sea accesible (se define en el script)
            if (!db || !userId) {
                showCustomModal("Error", "La base de datos no está inicializada o el usuario no está autenticado.");
                return;
            }

            try {
                // Eliminar de Firestore
                const docRef = doc(db, getCollectionPath(), id);
                await deleteDoc(docRef);
                
                // Eliminar del mapa (onSnapshot se encargará de esto, pero lo hacemos manual para respuesta inmediata)
                if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
                
                showCustomModal("Eliminado", "Punto de alumbrado eliminado correctamente.");
            } catch (error) {
                console.error("Error al eliminar el punto:", error);
                showCustomModal("Error", `No se pudo eliminar el punto: ${error.message}`);
            }
        }

        // Hacer la función deletePoint accesible globalmente para el onclick en el popup
        window.deletePoint = deletePoint;


        /**
         * Escucha cambios en tiempo real en la colección de puntos.
         */
        function setupRealtimeListener() {
            if (!db || !isAuthReady) return;

            const q = query(collection(db, getCollectionPath()));

            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docId = change.doc.id;
                    const data = change.doc.data();

                    if (change.type === "added" || change.type === "modified") {
                        addOrUpdateMarker(data, docId);
                        console.log(`Punto ${change.type}: `, data);
                    }
                    if (change.type === "removed") {
                        if (markers[docId]) {
                            map.removeLayer(markers[docId]);
                            delete markers[docId];
                            console.log("Punto eliminado: ", docId);
                        }
                    }
                });
            }, (error) => {
                console.error("Error al escuchar cambios en tiempo real:", error);
                document.getElementById('geo-status').textContent = `Error de escucha: ${error.message}`;
                document.getElementById('geo-status').className = 'text-xs font-medium text-red-500';
            });
        }
        
        /**
         * Carga datos iniciales (opcional, pues onSnapshot ya lo hace).
         */
        function loadInitialData() {
            // La función setupRealtimeListener ya maneja la carga inicial (type === "added")
            console.log("Se iniciará la escucha en tiempo real para cargar datos.");
        }


        /**
         * Manejador del botón Guardar.
         */
        document.getElementById('btn-save').addEventListener('click', async () => {
            if (!db || !userId) {
                showCustomModal("Error", "Base de datos no inicializada. Intenta recargar la página.");
                return;
            }

            const lat = parseFloat(document.getElementById('input-lat').value);
            const lng = parseFloat(document.getElementById('input-lng').value);
            const type = document.getElementById('select-type').value;
            const notes = document.getElementById('input-notes').value.trim();
            const saveStatus = document.getElementById('save-status');

            if (isNaN(lat) || isNaN(lng) || !type) {
                saveStatus.textContent = 'Por favor, haz clic en el mapa y selecciona un tipo de lámpara.';
                saveStatus.className = 'text-sm text-red-500';
                saveStatus.classList.remove('hidden');
                return;
            }

            const newPoint = {
                lat: lat,
                lng: lng,
                type: type,
                notes: notes,
                userId: userId,
                timestamp: new Date()
            };

            try {
                const docRef = await addDoc(collection(db, getCollectionPath()), newPoint);
                saveStatus.textContent = `¡Guardado! ID: ${docRef.id}`;
                saveStatus.className = 'text-sm text-green-600';
                saveStatus.classList.remove('hidden');

                // Limpiar formulario y deshabilitar botón
                document.getElementById('input-lat').value = '';
                document.getElementById('input-lng').value = '';
                document.getElementById('select-type').value = '';
                document.getElementById('input-notes').value = '';
                document.getElementById('btn-save').disabled = true;

                // Quitar el marcador temporal si existe
                if (map.newPointMarker) {
                    map.removeLayer(map.newPointMarker);
                    map.newPointMarker = null;
                }
            } catch (error) {
                console.error("Error al añadir el documento:", error);
                saveStatus.textContent = `Error al guardar: ${error.message}`;
                saveStatus.className = 'text-sm text-red-500';
                saveStatus.classList.remove('hidden');
            }
        });


        // --- Inicialización de la Aplicación ---

        /**
         * Inicializa Firebase, autentica al usuario y prepara los listeners de datos.
         */
        async function initializeFirebase() {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            const loadingOverlay = document.getElementById('loading-overlay');
            const appContainer = document.getElementById('app-container');
            const userIdDisplay = document.getElementById('user-id-display');
            const geoStatus = document.getElementById('geo-status');

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Error: __firebase_config está vacío.");
                geoStatus.textContent = "Error: Configuración de Firebase faltante o vacía.";
                geoStatus.className = 'text-xs font-medium text-red-500';
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('opacity-100');
                    if (map) { map.invalidateSize(); } // Importante para que el mapa se vea
                }, 300);
                return;
            }

            try {
                // 1. Inicializar Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Autenticación
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Listener de estado de autenticación (Se dispara después de signIn)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        userIdDisplay.textContent = userId;
                        
                        // Inicializar listeners de datos AHORA que el usuario está listo
                        loadInitialData();
                        setupRealtimeListener();

                        console.log(`Usuario autenticado (ID: ${userId}). Listos para datos.`);

                    } else {
                        userId = crypto.randomUUID();
                        isAuthReady = true;
                        userIdDisplay.textContent = `Anónimo (${userId.substring(0, 8)}...)`;
                        console.warn("Usuario no autenticado, usando ID anónimo.");

                        // Incluso si es anónimo, se inicializan los listeners
                        loadInitialData();
                        setupRealtimeListener();
                    }
                });

                // 4. Mostrar la aplicación y ocultar el overlay
                // ESTA ES LA CLAVE PARA MOSTRAR EL MAPA
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('opacity-100');
                    // *** ¡FORZAR EL REDIBUJO DEL MAPA! ***
                    if (map) {
                        map.invalidateSize();
                        console.log("Tamaño del mapa invalidado.");
                    }
                }, 300);


            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                
                let errorMessage;
                if (error.message.includes("auth/configuration-not-found")) {
                    errorMessage = "Error Crítico: Firebase: HABILITA 'Authentication' y el método 'Anónimo' en la Consola.";
                } else {
                    errorMessage = `Error Crítico de Inicialización: ${error.message}`;
                }
                    
                geoStatus.textContent = errorMessage;
                geoStatus.className = 'text-xs font-medium text-red-500';
                
                // Asegurar que el overlay se quite incluso con errores
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('opacity-100');
                    if (map) { map.invalidateSize(); } // Importante para que el mapa se vea
                }, 300);
            }
        }

        // --- Ejecución Principal ---

        // 1. Inicializar el mapa inmediatamente
        initializeMap();

        // 2. Iniciar la aplicación y la autenticación de Firebase
        initializeFirebase();

    </script>
</body>
</html>