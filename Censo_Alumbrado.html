<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Ciudadano de Luminarias</title>
    
    <!-- Incluir Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuración para usar la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- Estilos personalizados para el mapa -->
    <style>
        /* Asegura que el contenedor del mapa tenga una altura definida */
        #map {
            height: 400px; /* Altura fija para el mapa */
            width: 100%;
            border-radius: 0.5rem; /* Borde redondeado */
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-800">Reporte Ciudadano de Luminarias</h1>
            <p class="mt-2 text-lg text-gray-600">Ayúdanos a mantener la ciudad iluminada.</p>
        </header>

        <main class="bg-white p-6 rounded-xl shadow-2xl">
            <!-- Contenedor para mensajes de estado -->
            <div id="messageContainer" class="mb-4 hidden" role="alert">
                <div id="messageText" class="p-4 rounded-lg text-center font-medium"></div>
            </div>

            <form id="reporteForm" class="space-y-6">
                <!-- SECCIÓN MAPA -->
                <div class="border-b border-gray-200 pb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">1. Ubicación de la Luminaria/Poste</h2>
                    <p class="text-sm text-gray-500 mb-4">Haz clic en el mapa para marcar la ubicación exacta del problema. El mapa utiliza OpenStreetMap.</p>
                    
                    <div id="map" class="rounded-lg shadow-inner bg-gray-200 flex items-center justify-center">
                         <span id="map-loading-text" class="text-gray-600 font-medium">Cargando mapa...</span>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="latitud" class="block text-sm font-medium text-gray-700">Latitud</label>
                            <input type="text" id="latitud" name="latitud" required readonly
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 cursor-not-allowed">
                        </div>
                        <div>
                            <label for="longitud" class="block text-sm font-medium text-gray-700">Longitud</label>
                            <input type="text" id="longitud" name="longitud" required readonly
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 cursor-not-allowed">
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN DETALLES -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-900">2. Detalles del Reporte</h2>
                    
                    <!-- Tipo (Luminaria/Poste) -->
                    <div>
                        <label for="tipoLampara" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipoLampara" name="tipoLampara" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            <option value="">Seleccione el tipo</option>
                            <option value="poste">Poste</option> 
                            <option value="led">LED</option>
                            <option value="vaporSodio">Vapor de Sodio</option>
                            <option value="aditivosMetalicos">Aditivos Metálicos</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <!-- Falla -->
                    <div>
                        <label for="tipoFalla" class="block text-sm font-medium text-gray-700">Tipo de Falla</label>
                        <select id="tipoFalla" name="tipoFalla" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            <option value="">Seleccione el tipo de falla</option>
                            <option value="apagada">Apagada</option>
                            <option value="parpadeando">Parpadeando</option>
                            <option value="encendidaDia">Encendida durante el día</option>
                            <option value="danoFisico">Daño físico (vidrio roto, golpeado, etc.)</option>
                            <option value="cableado">Problema de cableado/alimentación</option>
                            <option value="posteCaido">Poste caído o muy inclinado</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <!-- Observaciones -->
                    <div>
                        <label for="observaciones" class="block text-sm font-medium text-gray-700">Observaciones adicionales (Opcional)</label>
                        <textarea id="observaciones" name="observaciones" rows="3"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"
                            placeholder="Describe brevemente el problema (ej: Hace ruido, la luz es muy débil, etc.)"></textarea>
                    </div>
                </div>

                <!-- Botón de Envío -->
                <button type="submit" id="submitButton"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:bg-gray-400">
                    <span id="buttonText">Enviar Reporte</span>
                    <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>

            <footer class="mt-8 pt-4 border-t text-center text-sm text-gray-500">
                <p>Reporte Ciudadano v1.3 (Leaflet/OSM). ID de Usuario: <span id="userIdDisplay" class="font-mono text-xs text-gray-700 bg-gray-100 p-1 rounded">Cargando...</span></p>
                <div id="authStatus" class="mt-1 text-xs text-red-500"></div>
            </footer>
        </main>
    </div>

    <!-- Script de Leaflet (OpenStreetMap) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6a9Kx/A6Z/z8u0h6W2z2R5S5Q/2gB1zW8k8t8u8w="
        crossorigin="">
    </script>

    <!-- Script principal de Firebase y Lógica (type="module") -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // Variables globales (de la aplicación)
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false; 
        
        // Configuraciones globales (proporcionadas por el entorno de Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Variables del Mapa (Leaflet)
        let map;
        let marker;
        // Coordenadas de la Ciudad de México
        const defaultCoords = [19.432608, -99.133209]; 
        const MAP_LOADING_TEXT = document.getElementById('map-loading-text');

        /**
         * Muestra un mensaje de estado en la UI.
         */
        function showMessage(message, type = 'success') {
            const container = document.getElementById('messageContainer');
            const textElement = document.getElementById('messageText');
            
            // Limpia clases anteriores
            container.classList.remove('hidden');
            textElement.className = '';

            if (type === 'success') {
                textElement.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                textElement.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'info') {
                 textElement.classList.add('bg-blue-100', 'text-blue-800');
            }
            textElement.textContent = message;
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                container.classList.add('hidden');
            }, 5000);
        }
        
        /**
         * Habilita/deshabilita el botón de envío y el spinner.
         */
        function toggleLoading(isLoading) {
            const button = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');
            const spinner = document.getElementById('spinner');

            button.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'Enviando...';
                spinner.classList.remove('hidden');
            } else {
                buttonText.textContent = 'Enviar Reporte';
                spinner.classList.add('hidden');
            }
        }
        
        /**
         * Actualiza los campos de Latitud/Longitud con las coordenadas del marcador.
         */
        function updateCoords(latlng) {
            document.getElementById('latitud').value = latlng.lat.toFixed(6);
            document.getElementById('longitud').value = latlng.lng.toFixed(6);
        }

        /**
         * Inicializa el mapa Leaflet.
         */
        function initMap() {
            try {
                // Ocultar texto de carga
                MAP_LOADING_TEXT.style.display = 'none';

                // Inicialización del mapa (utiliza la variable global L de Leaflet)
                map = L.map('map').setView(defaultCoords, 13); // [lat, lng], zoom 13

                // Añadir mosaicos de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Marcador arrastrable
                marker = L.marker(defaultCoords, {
                    draggable: true,
                    title: "Ubicación del Reporte"
                }).addTo(map);

                // Evento al hacer clic en el mapa (mueve el marcador)
                map.on('click', (e) => {
                    marker.setLatLng(e.latlng);
                    updateCoords(e.latlng);
                });

                // Evento al arrastrar el marcador
                marker.on('dragend', (e) => {
                    const latlng = e.target.getLatLng();
                    updateCoords(latlng);
                });

                // Cargar coordenadas iniciales en los campos
                const initialLatLng = marker.getLatLng();
                updateCoords(initialLatLng);
                
            } catch (e) {
                console.error("Leaflet Error (initMap):", e.message);
                MAP_LOADING_TEXT.textContent = "Error CRÍTICO al inicializar Leaflet. Recarga la página si el problema persiste.";
            }
        }
        
        // --- INICIALIZACIÓN DE FIREBASE Y AUTENTICACIÓN ---
        try {
            // Se inicializa Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Listener de cambio de estado de autenticación
            onAuthStateChanged(auth, async (user) => {
                const userIdDisplay = document.getElementById('userIdDisplay');
                const authStatus = document.getElementById('authStatus');

                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplay.textContent = userId;
                    authStatus.textContent = 'Autenticado.';
                    authStatus.classList.remove('text-red-500');
                    authStatus.classList.add('text-green-600');
                    
                    // Inicializar el mapa una vez que el script de Leaflet haya cargado
                    initMap(); 

                } else if (!isAuthReady) {
                    userIdDisplay.textContent = 'No autenticado.';
                    authStatus.textContent = 'Usuario no autenticado. Intentando autenticación anónima...';
                    try {
                        // Intenta iniciar sesión con el token personalizado o anónimamente
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error al autenticar:", error);
                        authStatus.textContent = `Error de autenticación: ${error.message}`;
                        showMessage(`Error de autenticación: ${error.message}`, 'error');
                        // Fallback ID
                        userId = `temp-user-${crypto.randomUUID()}`;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        initMap(); 
                    }
                }
            });

        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            showMessage(`Error al inicializar Firebase: ${error.message}. Verifica la configuración.`, 'error');
            document.getElementById('userIdDisplay').textContent = `temp-user-${crypto.randomUUID()}`;
        }
        
        // --- LÓGICA DEL FORMULARIO Y FIREBASE ---

        document.getElementById('reporteForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            toggleLoading(true);

            if (!isAuthReady || !db) {
                showMessage("La aplicación no está lista. Por favor, espera a que finalice la autenticación.", 'error');
                toggleLoading(false);
                return;
            }

            const latitud = document.getElementById('latitud').value;
            const longitud = document.getElementById('longitud').value;
            const tipoLampara = document.getElementById('tipoLampara').value;
            const tipoFalla = document.getElementById('tipoFalla').value;
            const observaciones = document.getElementById('observaciones').value;

            if (!latitud || !longitud || !tipoLampara || !tipoFalla) {
                showMessage("Por favor, selecciona una ubicación en el mapa y completa todos los campos requeridos.", 'error');
                toggleLoading(false);
                return;
            }

            const reporteData = {
                latitud: parseFloat(latitud),
                longitud: parseFloat(longitud),
                tipo: tipoLampara, 
                tipoFalla: tipoFalla,
                observaciones: observaciones,
                fechaReporte: new Date(),
                estado: 'Pendiente',
                reportadoPor: userId,
            };

            try {
                // Ruta para guardar datos públicos de la aplicación
                const reportesCollectionRef = collection(db, `artifacts/${appId}/public/data/reportesLuminarias`);
                const docRef = await addDoc(reportesCollectionRef, reporteData);

                showMessage(`¡Reporte enviado con éxito! ID de Tarea: ${docRef.id}`, 'success');
                
                document.getElementById('reporteForm').reset();
                
                // Restablecer el marcador al centro inicial
                if (typeof map !== 'undefined' && typeof marker !== 'undefined') {
                    const defaultLatLng = L.latLng(defaultCoords[0], defaultCoords[1]);
                    marker.setLatLng(defaultLatLng);
                    map.setView(defaultLatLng, 13);
                    updateCoords(defaultLatLng);
                }

            } catch (e) {
                console.error("Error al añadir el documento a Firestore: ", e);
                showMessage(`Error al enviar el reporte: ${e.message}`, 'error');
            } finally {
                toggleLoading(false);
            }
        });
    </script>
</body>
</html>